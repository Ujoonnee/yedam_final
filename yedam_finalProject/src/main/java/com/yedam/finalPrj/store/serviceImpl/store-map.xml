<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.yedam.finalPrj.store.serviceImpl.StoreMapper">
	<resultMap type="com.yedam.finalPrj.store.service.Store"
		id="store">
		<id property="store_no" column="store_no" />
		<result property="category" column="category" />
		<result property="name" column="name" />
		<result property="store_cat" column="store_cat" />
		<result property="address" column="address" />
		<result property="latitude" column="latitude" />
		<result property="longitude" column="longitude" />
		<result property="tel" column="tel" />
		<result property="thumbnail" column="thumbnail" />
	</resultMap>

	<sql id="StorePagingCriteria">

		<!-- 상태사항이 Y일 경우. -->
		<choose>
			<!-- 매장명 검색 -->
			<when test="type == 'name'">
				and name LIKE ('%'||#{keyword}||'%')
			</when>
			<!-- 카테고리 검색 -->
			<when test="type == 'store_cat'">
				and store_cat LIKE ('%'||#{keyword}||'%')
			</when>
			<!-- 상품명 검색 -->
			<when test="type == 'prod_name'">
				and prod_name LIKE ('%'||#{keyword}||'%')
			</when>

		</choose>

	</sql>
	<!-- 서비스 등록 -->
	<insert id="regist"
		parameterType="com.yedam.finalPrj.store.service.Store">
		<selectKey keyProperty="store_no" resultType="long"
			order="BEFORE">
			Select CASE when max(store_no) is null then 1
			ELSE MAX(store_no)
			+1 END from store
		</selectKey>
		insert into store values(
		#{store_no},#{category},#{name},#{store_cat},#{address},
		#{latitude},#{longitude},#{tel},#{thumbnail},4)
	</insert>

	<select id="storeList"
		resultType="com.yedam.finalPrj.store.service.Store">
  	
  		<![CDATA[
  		SELECT
    *
FROM
    (
        SELECT
            a.*,
            ROWNUM rn
        FROM
            (
               SELECT
                   store_no,
                   category,
                   name,
                   store_cat,
                   address,
                   latitude,
                  longitude,
                   tel,
                   thumbnail,
                   (
                       SELECT
                           get_distance(latitude, longitude, '30.8690794214', '128.5942180675')
                       FROM
                           store
                       WHERE
                           store.store_no = s.store_no
                   ) AS distance
               FROM
                   store s
               ORDER BY
                   distance
           ) a
       WHERE
           ROWNUM <= 4
    ) b
WHERE
    rn > 0

  		]]>

	</select>


	<select id="totalCnt" resultType="int">
		SELECT count(*)
		FROM store s
		<include refid="StorePagingCriteria"></include>
		and store_no > 0
	</select>

</mapper>