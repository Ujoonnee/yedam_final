<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.yedam.finalPrj.announcement.serviceImpl.AnnouncementMapper">

	<sql id="AnnouncementPagingCriteria">
		<!-- 상태사항이 Y일 경우. -->
		<choose>
			<!-- 제목검색 -->
			<when test="type == 'title'">
				AND TITLE LIKE ('%'||#{keyword}||'%')
			</when>
			<!-- 내용 검색 -->
			<when test="type == 'annContent'">
				AND ANN_CONTENT LIKE ('%'||#{keyword}||'%')
			</when>
		</choose>
	</sql>
	
	<select id="findAll" resultType="Announcement">
			SELECT ann_no, title, ann_content, ann_date, ann_view, status
			FROM	(SELECT rownum rn, ann_no, title, ann_content, ann_date, ann_view, get_code_name(status) status
				     FROM ANNOUNCEMENT
				     WHERE status IN ('00501','00502')
		<include refid="AnnouncementPagingCriteria"/>
	     <![CDATA[
            		 AND  rownum <= #{pageNum} * #{amount})
			WHERE rn > (#{pageNum}-1) * #{amount}
			ORDER BY ann_date DESC
		]]>
	</select>
	
	<select id="getTopList" resultType="Announcement">
		SELECT ann_no, title, ann_content, ann_date, ann_view, get_code_name(status) status
		FROM announcement
		WHERE status='00502'
	</select>

	<select id="findOne" resultType="Announcement">
		SELECT * FROM ANNOUNCEMENT WHERE ANN_NO = #{annNo}
	</select>

	<insert id="annInsert"
		parameterType="com.yedam.finalPrj.announcement.service.Announcement">
		<selectKey keyProperty="ANN_NO" resultType="int" order="BEFORE">
			SELECT ann_seq.nextval from dual
		</selectKey>
		INSERT INTO ANNOUNCEMENT(ANN_NO, TITLE, ANN_CONTENT,
		ANN_DATE, ANN_VIEW,
		STATUS, ANN_CNT)
		VALUES (#{annNo}, #{title},#{annContent},
		#{annDate}, #{annView}, DEFAULT, 0)
	</insert>
	
	<insert id="annInsertFile" parameterType="com.yedam.finalPrj.common.FileVO">
		insert into ATTACHED_FILE(file_no, ann_no, original_name, replaced_name, file_size)
			values(file_seq.nextval, #{annNo}, #{originalName}, #{replacedName}, #{fileSize})
	</insert>

	<update id="updateView" parameterType="Announcement">
		UPDATE ANNOUNCEMENT SET ann_view = ann_view + 1 WHERE
		ANN_NO = #{annNo}
	</update>




	<select id="totalCnt" resultType="int">
		SELECT count(*)
		FROM ANNOUNCEMENT
		WHERE status in('00501','00502')
		<include refid="AnnouncementPagingCriteria"/>
		AND ANN_NO>0
	</select>
</mapper>